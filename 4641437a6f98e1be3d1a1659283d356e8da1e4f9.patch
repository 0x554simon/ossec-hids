From 4641437a6f98e1be3d1a1659283d356e8da1e4f9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?V=C3=ADctor=20Manuel=20Fern=C3=A1ndez=20Castro?=
 <vmfdez90@gmail.com>
Date: Fri, 19 Feb 2016 17:57:33 +0100
Subject: [PATCH] Option to use authd without password

---
 src/os_auth/main-server.c | 50 ++++++++++++++++++++++++-----------------------
 1 file changed, 26 insertions(+), 24 deletions(-)

diff --git a/src/os_auth/main-server.c b/src/os_auth/main-server.c
index 4d2c6fa1..9ba2dece 100644
--- a/src/os_auth/main-server.c
+++ b/src/os_auth/main-server.c
@@ -147,6 +147,7 @@ int main(int argc, char **argv)
     int process_pool[POOL_SIZE];
     /* Count of pids we are wait()ing on */
     int c = 0, test_config = 0, use_ip_address = 0, pid = 0, status, i = 0, active_processes = 0;
+    int use_pass = 1;
     gid_t gid;
     int client_sock = 0, sock = 0, port = DEFAULT_PORT, ret = 0;
     const char *dir  = DEFAULTDIR;
@@ -199,7 +200,8 @@ int main(int argc, char **argv)
                 test_config = 1;
                 break;
             case 'n':
-                authpass = NULL;
+                use_pass = 0;
+                break;
             case 'p':
                 if (!optarg) {
                     ErrorExit("%s: -%c needs an argument", ARGV0, c);
@@ -270,33 +272,33 @@ int main(int argc, char **argv)
     /* Start up message */
     verbose(STARTUP_MSG, ARGV0, (int)getpid());
 
-    /* Checking if there is a custom password file */
-    fp = fopen(AUTHDPASS_PATH, "r");
-    buf[0] = '\0';
-    if (fp) {
-        buf[4096] = '\0';
-        char *ret = fgets(buf, 4095, fp);
-
-        if (ret && strlen(buf) > 2) {
-            /* Remove newline */
-            buf[strlen(buf) - 1] = '\0';
-            authpass = strdup(buf);
-        }
+    if (use_pass) {
 
-        fclose(fp);
-    }
+        /* Checking if there is a custom password file */
+        fp = fopen(AUTHDPASS_PATH, "r");
+        buf[0] = '\0';
+        if (fp) {
+            buf[4096] = '\0';
+            char *ret = fgets(buf, 4095, fp);
+
+            if (ret && strlen(buf) > 2) {
+                /* Remove newline */
+                buf[strlen(buf) - 1] = '\0';
+                authpass = strdup(buf);
+            }
 
-    if (buf[0] != '\0')
-        verbose("Accepting connections. Using password specified on file: %s",AUTHDPASS_PATH);
-    else {
-        /* Getting temporary pass. */
-        authpass = __generatetmppass();
+            fclose(fp);
+        }
 
-        if (authpass)
+        if (buf[0] != '\0')
+            verbose("Accepting connections. Using password specified on file: %s",AUTHDPASS_PATH);
+        else {
+            /* Getting temporary pass. */
+            authpass = __generatetmppass();
             verbose("Accepting connections. Random password chosen for agent authentication: %s", authpass);
-        else
-            verbose("Accepting insecure connections. No password required (not recommended)");
-    }
+        }
+    } else
+        verbose("Accepting insecure connections. No password required (not recommended)");
 
     /* Getting SSL cert. */
 
