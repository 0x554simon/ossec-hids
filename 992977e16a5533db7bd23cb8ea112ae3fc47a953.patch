From 992977e16a5533db7bd23cb8ea112ae3fc47a953 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?V=C3=ADctor=20Manuel=20Fern=C3=A1ndez=20Castro?=
 <vmfdez90@gmail.com>
Date: Thu, 18 Feb 2016 11:56:13 +0100
Subject: [PATCH] Fixes on password parsing

---
 src/os_auth/main-server.c | 37 +++++++++++++++++++++----------------
 1 file changed, 21 insertions(+), 16 deletions(-)

diff --git a/src/os_auth/main-server.c b/src/os_auth/main-server.c
index 6d3f1105..4d2c6fa1 100644
--- a/src/os_auth/main-server.c
+++ b/src/os_auth/main-server.c
@@ -169,9 +169,6 @@ int main(int argc, char **argv)
     /* Set the name */
     OS_SetName(ARGV0);
 
-    /* Getting temporary pass. */
-    authpass = __generatetmppass();
-
     while ((c = getopt(argc, argv, "Vdhtig:D:m:p:v:x:k:n")) != -1) {
         switch (c) {
             case 'V':
@@ -278,21 +275,27 @@ int main(int argc, char **argv)
     buf[0] = '\0';
     if (fp) {
         buf[4096] = '\0';
-        fgets(buf, 4095, fp);
-        if (strlen(buf) > 2) {
-            authpass = buf;
+        char *ret = fgets(buf, 4095, fp);
+
+        if (ret && strlen(buf) > 2) {
+            /* Remove newline */
+            buf[strlen(buf) - 1] = '\0';
+            authpass = strdup(buf);
         }
+
         fclose(fp);
     }
 
-    if (buf[0] != '\0') {
+    if (buf[0] != '\0')
         verbose("Accepting connections. Using password specified on file: %s",AUTHDPASS_PATH);
-    }
-    else if (authpass) {
-        verbose("Accepting connections. Random password chosen for agent authentication: %s", authpass);
-    }
     else {
-        verbose("Accepting insecure connections. No password required (not recommended)");
+        /* Getting temporary pass. */
+        authpass = __generatetmppass();
+
+        if (authpass)
+            verbose("Accepting connections. Random password chosen for agent authentication: %s", authpass);
+        else
+            verbose("Accepting insecure connections. No password required (not recommended)");
     }
 
     /* Getting SSL cert. */
@@ -317,9 +320,10 @@ int main(int argc, char **argv)
         merror("%s: Unable to bind to port %d", ARGV0, port);
         exit(1);
     }
-    fcntl(sock, F_SETFL, O_NONBLOCK);
 
+    fcntl(sock, F_SETFL, O_NONBLOCK);
     debug1("%s: DEBUG: Going into listening mode.", ARGV0);
+
     while (1) {
         /* No need to completely pin the cpu, 100ms should be fast enough */
         usleep(100 * 1000);
@@ -371,7 +375,6 @@ int main(int argc, char **argv)
                     }
 
                 } while (ret <= 0);
-
                 verbose("%s: INFO: New connection from %s", ARGV0, srcip);
                 buf[0] = '\0';
 
@@ -390,10 +393,12 @@ int main(int argc, char **argv)
                 /* Checking for shared password authentication. */
                 if(authpass) {
                     /* Format is pretty simple: OSSEC PASS: PASS WHATEVERACTION */
-                    if (strncmp(tmpstr, "OSSEC PASS:", 12) == 0) {
+                    if (strncmp(tmpstr, "OSSEC PASS: ", 12) == 0) {
                         tmpstr = tmpstr + 12;
+
                         if (strlen(tmpstr) > strlen(authpass) && strncmp(tmpstr, authpass, strlen(authpass)) == 0) {
-                            tmpstr = tmpstr + strlen(authpass);
+                            tmpstr += strlen(authpass);
+
                             if (*tmpstr == ' ') {
                                 tmpstr++;
                                 parseok = 1;
